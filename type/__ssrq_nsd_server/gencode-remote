#!/bin/sh -e
#
# 2020 Dennis Camera (dennis.camera@ssrq-sds-fds.ch)
#
# This file is part of cdist.
#
# cdist is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# cdist is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with cdist. If not, see <http://www.gnu.org/licenses/>.
#

drop_awk_comments() { sed '/^[[:blank:]]*#.*$/d;/^$/d' "$@"; }

CONF_BASE_PATH=/etc/nsd
nsd_conf="${CONF_BASE_PATH}/nsd.conf"

os=$(cat "${__global:?}/explorer/os")

if grep -q '^__package[_a-z]*/nsd[0-9]*:installed' "${__messages_in:?}"
then
	fresh_install=true
else
	fresh_install=false
fi

# Install post-processing
if $fresh_install
then
	# Run `nsd-control-setup` after install
	echo 'nsd-control-setup'

	# NOTE: The nsd service needs to be restarted if it is running to make
	#       nsd-control work.
	# XXX: Should we also start the service when it hasn't been running before?
	case $(cat "${__global:?}/explorer/init")
	in
		(systemd)
			echo 'systemctl try-restart nsd.service'
			;;
		(sysvinit)
			cat <<-'EOF'
			if test -x /etc/init.d/nsd && /etc/init.d/nsd status >/dev/null 2>&1
			then
			    /etc/init.d/nsd restart
			fi
			EOF
			;;
		(*openrc*)
			echo 'rc-service --ifstarted nsd restart'
			;;
		(*)
			echo "Don't know how to restart service with your init. "\
			     "Restart nsd service manually to make nsd-control work." >&2
	esac

	# OS-specific processing
	case $os
	in
		(debian|devuan)
			# Debian does not install a proper config file in /etc/nsd/nsd.conf,
			# so we copy the example.
			cat <<-'EOF'
			if test -r /usr/share/doc/nsd/examples/nsd.conf.gz
			then
			    zcat /usr/share/doc/nsd/examples/nsd.conf.gz >/etc/nsd/nsd.conf
			elif test -r /usr/share/doc/nsd/examples/nsd.conf.sample.gz
			then
			    zcat /usr/share/doc/nsd/examples/nsd.conf.sample.gz >/etc/nsd/nsd.conf
			fi
			EOF
			;;
	esac

	# Config post-processing
	# Ensure that *.conf files from nsd.conf.d are included
	cat <<-'EOF'
	grep -q '^include: "/etc/nsd/nsd\.conf\.d/\*\(\.conf\)\{,1\}?"' '${nsd_conf}' \
	|| printf '\ninclude: "/etc/nsd/nsd.conf.d/*.conf"\n' >>'${nsd_conf}'
	EOF
fi


# Config
diff=$(
	diff_line() {
		printf '%s %s: %s\n' "$1" "$2" "$(printf "${3:-%s}" "${4-}")";
	}

	# Automatic options (the type guesses the correct value automatically)
	if test -s "${__global:?}/explorer/cpu_cores"
	then
		diff_line = server:server-count %u "$(
			head -n 1 "${__global:?}/explorer/cpu_cores")"
	fi

	# Boolean options
	for _opt in hide-identity hide-version refuse-any
	do
		if test -f "${__object:?}/parameter/${_opt}"
		then
			diff_line = "server:${_opt}" %s yes
		else
			diff_line - "server:${_opt}"
		fi
	done
	if test -f "${__object:?}/parameter/no-ipv4"
	then
		diff_line = server:do-ip4 %s no
	else
		diff_line - server:do-ip4
	fi
	if test -f "${__object:?}/parameter/no-ipv6"
	then
		diff_line = server:do-ip6 %s no
	else
		diff_line - server:do-ip6
	fi

	# "Singleton" options
	if test -f "${__object:?}/parameter/database"
	then
		diff_line = server:database '"%s"' "$(
			head -n 1 "${__object:?}/parameter/database")"
	fi
	if test -f "${__object:?}/parameter/port"
	then
		diff_line = server:port %u "$(head -n 1 "${__object:?}/parameter/port")"
	fi
	if test -f "${__object:?}/parameter/zonesdir"
	then
		diff_line = server:zonesdir '"%s"' "$(head -n 1 "${__object:?}/parameter/zonesdir")"
	fi

	# Multiple options
	diff_line - server:ip-address
	if test -s "${__object:?}/parameter/interface"
	then
		while read -r _line
		do
			diff_line + server:ip-address %s "${_line}"
		done <"${__object:?}/parameter/interface"
	fi

	# TODO: remote-control section
)

if test -n "${diff}"
then
	cat <<CODE
awk '$(drop_awk_comments "${__type:?}/files/update_nsd_conf.awk")' '${nsd_conf}' <<'EOF' >'${nsd_conf}.tmp' \
&& cat '${nsd_conf}.tmp' >'${nsd_conf}'
${diff}
EOF
rm '${nsd_conf}.tmp'
CODE

	config_updated=true
	echo 'config updated' >>"${__messages_out:?}"
fi
